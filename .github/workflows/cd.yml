name: CD

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths:
      - .github/workflows/*
      - src/**
      - '*.md'

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: true
      matrix:
        experimental: [true]
        os: [ubuntu-latest, windows-latest, macos-latest]
        arch: [amd64, arm64]

    name: ðŸš€ CD on ${{ matrix.os }} ${{ matrix.arch }}

    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v5

      - name: ðŸ”§ Setup Vlang
        uses: siguici/setup-v@v0

      - name: ðŸ“¦ Build for Unix
        if: runner.os != 'Windows'
        run: |
          mkdir -p bin
          EXT=""
          if [ "$RUNNER_OS" = "windows" ]; then
            EXT=".exe"
          fi
          OUTPUT="bin/sg_${RUNNER_OS}_${{ matrix.arch }}${EXT}"
          echo "Building $OUTPUT..."
          v -prod -arch ${{ matrix.arch }} . -o $OUTPUT
          zip -j "${OUTPUT}.zip" "$OUTPUT"
          sha256sum "${OUTPUT}.zip" > "${OUTPUT}.zip.sha256"

      - name: ðŸ“¦ Build for Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path bin
          $ext = ".exe"
          $output = "bin\sg_${env:RUNNER_OS}_${{ matrix.arch }}$ext"
          Write-Host "Building $output..."
          v -native -os windows -arch ${{ matrix.arch }} . -o $output
          Compress-Archive -Path $output -DestinationPath "$output.zip"
          Get-FileHash "$output.zip" -Algorithm SHA256 | ForEach-Object { $_.Hash } | Set-Content "$output.zip.sha256"

      - name: ðŸ“‚ Upload binaries
        id: gh_release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          files: |
            bin/*.zip
            bin/*.zip.sha256
            *.md
